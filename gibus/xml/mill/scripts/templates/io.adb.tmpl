--
-- Created by ada_generator.py on $date
-- 
with $dataPackageName;


with Ada.Containers.Vectors;
with Ada.Containers; use Ada.Containers;

with environment;

with db_commons; 
with db_commons.odbc; 

with GNU.DB.SQLCLI;  
with GNU.DB.SQLCLI.Bind;
with GNU.DB.SQLCLI.Info;
with GNU.DB.SQLCLI.Environment_Attribute;
with GNU.DB.SQLCLI.Connection_Attribute;

with Ada.Exceptions;  
with Ada.Strings; 
with Ada.Strings.Wide_Fixed;
with Ada.Characters.Conversions;
with Ada.Strings.Unbounded; 
with text_io;
with Ada.Strings.Maps;

#for $withs in $localWiths
with $withs;
#end for

with Logger;

package body $IOName is

   use Ada.Strings.Unbounded;
   use Ada.Exceptions;
   use Ada.Strings;

   package dodbc renames db_commons.odbc;
   package sql renames GNU.DB.SQLCLI;
   package sql_info renames GNU.DB.SQLCLI.Info;
   use sql;
   use base_types;
   --
   -- generic packages to handle each possible type of decimal, if any, go here
   --
#for $dec in $decimalDeclarations:
   $dec;
#end for
   
   --
   -- Select all variables; substring to be competed with output from some criteria
   --
   $selectPart;
   
   --
   -- Insert all variables; substring to be competed with output from some criteria
   --
   $insertPart;

   
   --
   -- delete all the records identified by the where SQL clause 
   --
   $deletePart;
   
   --
   -- update
   --
   $updatePart;
   
   function get_connection return dodbc.Database_Connection is
      use dodbc;
      con : dodbc.Database_Connection := dodbc.Null_Database_Connection;
   begin
      con := dodbc.connect( 
            environment.Get_Server_Name, 
            environment.Get_Username, 
            environment.Get_Password );
      return con;
      exception 
      when Error : others =>  
         Logger.error( "exception " & Exception_Information(Error) ); 
         Raise_Exception( d.DB_Exception'Identity, 
            "getConnection: exception thrown " & Exception_Information(Error) );
   end get_connection;
   
#for $ass in $incr_integer_pk_fields
$ass
#end for

   --
   -- returns true if the primary key parts of $outputRecordName match the defaults in $nullName
   --
$isNullFunc
   
   --
   -- returns true if the container is empty
   --
$isEmptyFunc

   --
   -- returns number of items of the container 
   --
$cardFunc

   --
   -- returns the single $outputRecordName matching the primary key fields, or the $nullName record
   -- if no such record exists
   --
$pkFunc
   
   --
   -- Retrieves a list of $outputRecordType matching the criteria, or throws an exception
   --
$retrieveByCFunc
   
   --
   -- Retrieves a list of $outputRecordType retrived by the sql string, or throws an exception
   --
$retrieveBySFunc
   
   --
   -- Update the given record 
   -- otherwise throws DB_Exception exception. 
   --
$updateFunc
   --
   -- Save the compelete given record 
   -- otherwise throws DB_Exception exception. 
   --
$saveFunc
   
   --
   -- Delete the given record. Throws DB_Exception exception. Sets value to $nullName
   --

$deleteSpecificFunc

   --
   -- delete the records indentified by the criteria
   --
   procedure Delete( c : d.Criteria ) is
   begin      
      delete( d.to_string( c ) );
      Logger.info( "delete criteria; execute query OK" );
   end Delete;
   
   procedure Delete( where_Clause : String ) is
      ps : sql.SQLHDBC := sql.SQL_NULL_HANDLE;
      connection : dodbc.Database_Connection;
      query : Unbounded_String := DELETE_PART & To_Unbounded_String(" ");
   begin
      query := query & where_Clause;
      begin -- try catch block for execute
         Logger.info( "delete; executing query" & To_String(query) );
         connection := get_connection;
         ps := dodbc.Initialise_Prepared_Statement( connection.connection, query );       
         SQLExecute( ps );
         Logger.info( "delete; execute query OK" );
      exception 
         when Error : No_Data => Null; -- silently ignore no data exception, which is hardly exceptional
         when Error : others =>
            Logger.error( "delete; execute query failed with message " & Exception_Information(Error)  );
            -- Raise_Exception( d.DB_Exception'Identity, 
               -- "delete: exception thrown " & Exception_Information(Error) );
	Reraise_Occurrence(Error);

      end;
      begin -- try catch block for close
         dodbc.Close_Prepared_Statement( ps );
         dodbc.Disconnect( connection );
      exception 
         when Error : others =>
            Logger.error( "delete; execute query failed with message " & Exception_Information(Error)  );
            --Raise_Exception( d.DB_Exception'Identity, 
              -- "delete: exception thrown " & Exception_Information(Error) );
	Reraise_Occurrence(Error);

      end;
   end Delete;


   --
   -- functions to retrieve records from tables with foreign keys
   -- referencing the table modelled by this package
   --
#for $ass in $associated:
$ass
#end for

   --
   -- functions to add something to a criteria
   --
#for $cr in $criteria
$cr
#end for
   
   --
   -- functions to add an ordering to a criteria
   --
#for $ord in $orderingStatements
$ord
#end for
   
end $IOName;
